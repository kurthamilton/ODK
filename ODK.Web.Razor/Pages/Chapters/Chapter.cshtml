@page "/{chapterName:regex(^[A-Za-z-]+$)}"
@using ODK.Core.Platforms
@using ODK.Services.Chapters
@using ODK.Web.Common.Routes
@using ODK.Web.Razor.Models.Components
@model ODK.Web.Razor.Pages.Chapters.ChapterModel
@inject IChapterViewModelService ChapterViewModelService
@{
    Layout = "_OdkChapterLayout";

    var chapter = Model.Chapter;
    var viewModel = await ChapterViewModelService.GetHomePage(
        Model.ServiceRequest, Model.CurrentMemberOrDefault, chapter);

    var description = viewModel.Chapter.GetDisplayName(Model.Platform);

    if (!string.IsNullOrEmpty(viewModel.Texts?.Description))
    {
        description += ". " + viewModel.Texts.Description;
    }
    else if (Model.Platform == PlatformType.DrunkenKnitwits)
    {
        description += ". We are the Drunken Knitwits, and we are knit-aholics. Sip by sip and stitch by stitch, we continue to pursue drunken, hand-cramping knit-thood, whereby all Knitwits have the holy grail of drunken knitting to show off to our friends: a hand-crafted item whose place, time, and method of construction cannot entirely be recalled";
    }

    Model.Description = description;
    Model.Path = Model.OdkRoutes.Groups.Group(Model.Chapter);
    Model.Keywords = viewModel.Topics
        .Select(x => x.Name)
        .ToArray();
    Model.Location = viewModel.ChapterLocation;
}

@if (!viewModel.Chapter.IsOpenForRegistration())
{
    @await Html.PartialAsync("Components/_Body", new BodyViewModel
    {
        Title = viewModel.Chapter.FullName,
        Content = await Html.PartialAsync("Groups/_GroupRegistrationClosed", viewModel.Chapter)
    })

    return;
}

@await Html.PartialAsync("Components/_BodyWithSidebar", new BodyWithSidebarViewModel
{
    Title = viewModel.Chapter.GetDisplayName(Model.Platform),
    Content = await Html.PartialAsync("Chapters/_ChapterContent", viewModel),
    SidebarContent = await Html.PartialAsync("Chapters/_ChapterSidebar", viewModel)
})