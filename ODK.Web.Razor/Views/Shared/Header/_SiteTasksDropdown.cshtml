@using ODK.Services.Chapters
@using ODK.Web.Common.Components
@using ODK.Web.Common.Routes
@using ODK.Web.Common.Services
@using ODK.Web.Razor.Models
@using ODK.Web.Razor.Models.Components
@using ODK.Web.Razor.Services
@inject IChapterService ChapterService
@inject IOdkRoutes OdkRoutes
@inject IRequestStore RequestStore
@{
    var platform = RequestStore.Platform;
    var memberId = RequestStore.CurrentMemberIdOrDefault;

    var ownedChapters = memberId != null
        ? await ChapterService.GetChaptersByOwnerId(RequestStore.ServiceRequest, memberId.Value)
        : [];

    var notificationCount = 0;

    var chaptersPendingPublication = ownedChapters
        .Where(x => x.CanBePublished())
        .ToArray();

    notificationCount += chaptersPendingPublication.Length;    
}

@if (notificationCount > 0)
{
    <div class="dropdown position-relative" role="button">
        <span class="position-absolute top-0 start-100 translate-middle badge badge-sm rounded-pill bg-danger">
            <span>@(notificationCount > 9 ? "9+" : notificationCount.ToString())</span>
            <span class="visually-hidden">pending tasks</span>
        </span>

        <div class="text-light account-links__user dropdown-toggle"
             data-bs-toggle="dropdown" data-bs-auto-close="outside">
            @await Html.PartialAsync("Components/_Icon", new IconViewModel(IconType.TodoList))
        </div>
        <div class="dropdown-menu dropdown-menu-end p-0">
            <div class="dropdown-header">
                <h5 class="m-0">Pending tasks</h5>
            </div>
            @if (chaptersPendingPublication.Length > 0)
            {
                @foreach (var chapter in chaptersPendingPublication)
                {
                    <a class="dropdown-item border-top p-3" href="@OdkRoutes.GroupAdmin.Group(chapter).Path">
                        <strong>@chapter.GetDisplayName(platform)</strong> is waiting to be published
                    </a>
                }                
            }
        </div>
    </div>
}