@using ODK.Services.Authentication
@using ODK.Web.Common.Components
@using ODK.Web.Common.Routes
@using ODK.Web.Razor.Models.Components
@using ODK.Web.Razor.Models.Header
@using ODK.Web.Razor.Services
@inject IRequestStore RequestStore
@model AccountMenuViewModel
@{
    var platform = RequestStore.Platform;

    var adminChapters = Model.MemberChapters
        .Where(x => Model.Member?.IsMemberOf(x.Id) == true)
        .ToArray();

    var defaultChapter = Model.CurrentChapter != null && Model.Member != null && Model.Member.IsMemberOf(Model.CurrentChapter.Id)
        ? Model.CurrentChapter
        : Model.MemberChapters.FirstOrDefault();

    var isAdmin = User.IsInRole(OdkRoles.Admin);
}

@if (Model.MemberChapters.Count > 0)
{
    <div class="account-links" role="button">
        <div class="dropdown">
            <div class="text-light account-links__user dropdown-toggle" data-bs-toggle="dropdown">
                @await Html.PartialAsync("Components/_Icon", new IconViewModel(IconType.User))
            </div>
            <div class="dropdown-menu dropdown-menu-end text-end">
                @if (Model.MemberChapters.Count == 1)
                {
                    var memberChapter = Model.MemberChapters.First();
                    var adminChapter = isAdmin ? adminChapters
                        .FirstOrDefault(x => x.Id == memberChapter.Id) : null;

                    <a class="dropdown-item" href="@OdkRoutes.Account.Index(memberChapter)">
                        My profile
                    </a>
                    <a class="dropdown-item" href="@OdkRoutes.Groups.Group(platform, memberChapter)">
                        @memberChapter.GetDisplayName(platform)
                    </a>
                    <a class="dropdown-item" href="/@memberChapter.ShortName/Account/Logout">
                        Sign Out
                    </a>
                    
                    @if (adminChapter != null)
                    {
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="/@adminChapter.ShortName/Admin/Chapter/Text">
                            @adminChapter.GetDisplayName(platform) Admin
                        </a>
                        <a class="dropdown-item" href="/@adminChapter.ShortName/Admin/Events/Create">Create event</a>
                    }
                }
                else if (Model.MemberChapters.Count > 1)
                {
                    for (var i = 0; i < Model.MemberChapters.Count; i++)
                    {
                        var memberChapter = Model.MemberChapters.ElementAt(i);
                        var adminChapter = isAdmin ? adminChapters
                            .FirstOrDefault(x => x.Id == memberChapter.Id) : null;

                        <div class="dropdown dropstart">
                            <div class="dropdown-item dropdown-toggle" data-bs-toggle="dropdown">
                                @memberChapter.GetDisplayName(platform)
                            </div>
                            <div class="dropdown-menu text-end">
                                <a class="dropdown-item" href="@OdkRoutes.Groups.Group(platform, memberChapter)">
                                    Home
                                </a>
                                <a class="dropdown-item" href="@OdkRoutes.Account.Index(memberChapter)">
                                    My profile
                                </a>

                                @if (adminChapter != null)
                                {
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item" href="/@adminChapter.ShortName/Admin/Chapter/Text">Admin</a>
                                    <a class="dropdown-item" href="/@adminChapter.ShortName/Admin/Events/Create">Create event</a>

                                    if (Model.Member?.SiteAdmin == true)
                                    {
                                        <a class="dropdown-item" href="/@adminChapter.ShortName/admin/siteadmin">Site admin</a>
                                    }
                                }
                            </div>                            
                        </div>                                                                        
                    }

                    <div class="dropdown-divider"></div>

                    @if (defaultChapter != null)
                    {
                        <a class="dropdown-item" href="/@defaultChapter.ShortName/Account/Logout">Sign Out</a>
                    }                    
                }

                <div class="dropdown-divider"></div>
                <a class="dropdown-item" href="#" data-theme-selector="dark">Dark mode</a>
                <a class="dropdown-item" href="#" data-theme-selector="light">Light mode</a>                
            
                @if (Model.Member?.SiteAdmin == true)
                {                                        
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="/siteadmin">Site admin</a>
                }
            </div>
        </div>
    </div>
}