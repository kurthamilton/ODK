@using ODK.Core.Pages
@using ODK.Core.Platforms
@using ODK.Web.Common.Routes
@using ODK.Web.Common.Services
@using ODK.Web.Razor.Models.Components
@using ODK.Web.Razor.Models.Header
@using ODK.Web.Razor.Services
@model ChapterHeaderViewModel
@inject IOdkRoutes OdkRoutes
@inject IRequestStore RequestStore
@{
    var platform = RequestStore.Platform;

    var isMember = Model.Member?.IsMemberOf(Model.Chapter.Id) == true;
    var pages = Model.Pages
        .ToDictionary(x => x.PageType);

    var menuItems = new List<MenuItem>();

    menuItems.Add(new MenuItem 
    { 
        Text = "Events", 
        Link = OdkRoutes.Groups.Events(Model.Chapter)
    });

    if (isMember)
    {
        pages.TryGetValue(PageType.Members, out var membersPage);

        if (membersPage?.Hidden != true)
        {
            menuItems.Add(new MenuItem
            {
                Text = !string.IsNullOrEmpty(membersPage?.Title) ? membersPage.Title : "Knitwits",
                Link = OdkRoutes.Groups.Members(Model.Chapter)
            });
        }        
    }

    pages.TryGetValue(PageType.Contact, out var contactPage);

    if (contactPage?.Hidden != true)
    {
        menuItems.Add(new MenuItem
        {
            Text = !string.IsNullOrEmpty(contactPage?.Title) ? contactPage.Title : "Contact",
            Link = OdkRoutes.Groups.Contact(Model.Chapter)
        });
    }

    pages.TryGetValue(PageType.About, out var aboutPage);

    if (aboutPage?.Hidden != true)
    {
        menuItems.Add(new MenuItem
        {
            Text = !string.IsNullOrEmpty(aboutPage?.Title) ? aboutPage.Title : "About",
            Link = OdkRoutes.Groups.About(Model.Chapter)
        });
    }    
}

@await Html.PartialAsync("Header/_Header", new HeaderViewModel
{
    ImageAltText = $"{Model.Chapter.GetDisplayName(platform)} Header Image",
    ImageLink = OdkRoutes.Groups.Group(Model.Chapter),
    ImageUrl = Model.Chapter.BannerImageUrl,
    Navbar = new NavbarViewModel
    {
        Breakpoint = "md",
        Chapter = Model.Chapter,
        Color = "dark",
        Compact = false,
        CssClass = null,
        Member = Model.Member,
        MenuItems = new []
        {
            menuItems.ToArray()
        }
    }
})