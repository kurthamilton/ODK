@using ODK.Core.Chapters
@using ODK.Core.Countries
@using ODK.Core.Features
@using ODK.Services
@using ODK.Services.Chapters
@using ODK.Services.Members
@using ODK.Services.Members.ViewModels
@using ODK.Web.Common.Components
@using ODK.Web.Common.Extensions
@using ODK.Web.Common.Routes
@using ODK.Web.Razor.Models.Admin
@using ODK.Web.Razor.Models.Admin.Members
@using ODK.Web.Razor.Models.Components
@model SubscriptionsAdminPageViewModel
@inject IOdkRoutes OdkRoutes
@{        
    var (subscriptions, membershipSettings) = 
        (Model.ChapterSubscriptions, Model.MembershipSettings);
}

<section class="section">
    @if (subscriptions.Count == 0)
    {
        <p>
            Charge your members a subscription fee to cover your group running costs.
        </p>
    }

    @await Html.PartialAsync("Components/_RestrictedFeature", new RestrictedFeatureViewModel(Model.OwnerSubscription)
    {
        Chapter = Model.Chapter,
        Feature = SiteFeatureType.MemberSubscriptions,
        ContentFunc = 
            @<div>
                @if (Model.MembershipSettings?.Enabled != true)
                {
                    <div class="alert alert-warning">
                        Membership is currently disabled. 
                        @await Html.PartialAsync("Admin/_AdminLink", new AdminLinkViewModel
                        {
                            Route = OdkRoutes.GroupAdmin.MembershipSettings(Model.Chapter),
                            Text = "Update membership settings"
                        })
                    </div>
                }

                <p>
                    @await Html.PartialAsync("Admin/_AdminLink", new AdminLinkViewModel
                    {
                        Class = "btn btn-primary",
                        Route = OdkRoutes.GroupAdmin.MembersSubscriptionCreate(Model.Chapter),
                        Text = "Create subscription"
                    })                    
                </p>

                <div class="table-responsive">
                    <table class="table table-striped mb-5">
                        <thead>
                        <tr>
                            <th class="tcol-narrow"></th>
                            <th>Name</th>
                            <th>Amount</th>
                            <th>Months</th>
                            <th>Enabled</th>
                            <th class="tcol-narrow"></th>
                        </tr>
                        </thead>
                        <tbody>
                        @foreach (var dto in subscriptions)
                        {
                            var subscription = dto.ChapterSubscription;

                            <tr>
                                <td>
                                    @if (subscription.Recurring)
                                    {
                                        <span data-bs-toggle="tooltip" title="Recurring susbcription">
                                            @await Html.PartialAsync("Components/_Icon", new IconViewModel(IconType.ArrowsSpin))
                                        </span>
                                    }
                                </td>    
                                <td>
                                    @await Html.PartialAsync("Admin/_AdminLink", new AdminLinkViewModel
                                    {
                                        Route = OdkRoutes.GroupAdmin.MembersSubscription(Model.Chapter, subscription),
                                        Text = subscription.Name
                                    })
                                </td>                                
                                <td>
                                    @subscription.Currency.ToAmountString(subscription.Amount)
                                </td>
                                <td>@subscription.Months</td>
                                <td>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" disabled
                                            checked="@(!subscription.Disabled ? "" : null)" />
                                    </div>
                                </td>
                                <td>
                                    @if (!dto.Used)
                                    {
                                        <form method="post" action="/groups/@Model.Chapter.Id/members/subscriptions/@subscription.Id/delete">
                                            <button data-bs-toggle="tooltip" data-bs-title="Delete" class="btn-icon text-danger"
                                                    onclick="return confirm('Are you sure you want to delete this subscription?');">
                                                @await Html.PartialAsync("Components/_Icon", new IconViewModel(IconType.Times))
                                            </button>
                                        </form>
                                    }                                    
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            </div>
    })
</section>