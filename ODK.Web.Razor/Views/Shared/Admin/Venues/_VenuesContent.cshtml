@using ODK.Core.Events
@using ODK.Core.Utils
@using ODK.Core.Venues
@using ODK.Services
@using ODK.Services.Events
@using ODK.Services.Venues.ViewModels
@using ODK.Web.Common.Extensions
@using ODK.Web.Common.Routes
@using ODK.Web.Razor.Models.Admin
@model VenuesAdminPageViewModel
@inject IOdkRoutes OdkRoutes
@{    
    var (venues, events) = (Model.Venues, Model.Events);

    var eventCounts = events
        .GroupBy(x => x.VenueId)
        .ToDictionary(x => x.Key, x => x.Count());
    var lastEvents = events
        .GroupBy(x => x.VenueId)
        .ToDictionary(x => x.Key, x => x.Max(_ => _.Date));
}

<p>
    @await Html.PartialAsync("Admin/_AdminLink", new AdminLinkViewModel
    {
        Class = "btn btn-primary",
        Route = OdkRoutes.GroupAdmin.VenueCreate(Model.Chapter),
        Text = "Create"
    })
</p>

<div class="table-responsive">
    <table class="table table-striped" data-sortable>
        <thead>
            <tr>
                <th data-sortable-sort="default">Name</th>
                <th>Address</th>
                <th data-sortable-sort data-sortable-dir="desc">Events</th>
                <th data-sortable-sort data-sortable-dir="desc">Last Event</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var venue in venues.OrderBy(x => x.Name))
            {
                <tr>
                    <td>
                        <span class="d-none" data-sort-value="@venue.Name"></span>
                        @await Html.PartialAsync("Admin/_AdminLink", new AdminLinkViewModel
                        {
                            Route = OdkRoutes.GroupAdmin.Venue(Model.Chapter, venue.Id),
                            Text = venue.Name
                        })
                    </td>
                    <td>@venue.MapQuery</td>
                    <td>@(eventCounts.ContainsKey(venue.Id) ? eventCounts[venue.Id] : 0)</td>
                    <td>
                        @if (lastEvents.TryGetValue(venue.Id, out DateTime lastEventDate))
                        {
                            <span class="d-none" data-sort-value="@lastEventDate.ToString("yyyy-MM-dd")"></span>
                            @lastEventDate.EventDate()
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>