@using ODK.Core.Chapters
@using ODK.Core.Utils
@using ODK.Services.Chapters.ViewModels
@using ODK.Services.Security
@using ODK.Web.Common.Routes
@using ODK.Web.Common.Services
@using ODK.Web.Razor.Models.Admin
@model ChapterConversationsAdminPageViewModel
@inject IOdkRoutes OdkRoutes

<p>Contact messages sent by logged in users</p>

<p>
    <span>Your </span>
    @await Html.PartialAsync("Admin/_AdminLink", new AdminLinkViewModel
    {
        Route = OdkRoutes.GroupAdmin.Privacy(Model.Chapter),
        Text = "privacy settings",
        UnauthorizedBehaviour = AdminLinkUnauthorizedBehaviour.Disable
    })
    <span>currently allow</span>
    @switch (Model.PrivacySettings?.Conversations)
    {
        case null:
        case ChapterFeatureVisibilityType.Public:
            @: anyone logged in
            break;
        case ChapterFeatureVisibilityType.ActiveMembers:
            @: active members
            break;
        case ChapterFeatureVisibilityType.AllMembers:
            @: all members
            break;
    }

    to start conversations.
</p>

@await Html.PartialAsync("Admin/Chapter/Conversations/_ConversationsAdminTabs")

@if (Model.Conversations.Count > 0)
{
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>From</th>
                    <th>Subject</th>
                    <th>Started</th>
                    <th>Last message</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var dto in Model.Conversations.OrderByDescending(x => x.LastMessage.Message.CreatedUtc))
                {
                    var (conversation, member) = (dto.Conversation, dto.Member);

                    <tr>
                        <td>
                            @if (dto.Member.IsMemberOf(Model.Chapter.Id))
                            {
                                @await Html.PartialAsync("Admin/_AdminLink", new AdminLinkViewModel
                                {
                                    Route = OdkRoutes.GroupAdmin.Member(Model.Chapter, member.Id),
                                    Text = member.FullName
                                })
                            }
                            else
                            {
                                @dto.Member.FullName
                            }
                        </td>
                        <td>
                            @await Html.PartialAsync("Admin/_AdminLink", new AdminLinkViewModel
                            {
                                Route = OdkRoutes.GroupAdmin.Conversation(Model.Chapter, conversation.Id),
                                Text = conversation.Subject
                            })                            
                        </td>
                        <td>@conversation.CreatedUtc.ToFriendlyDateTimeString(Model.Chapter.TimeZone)</td>
                        <td>
                            <div>
                                @dto.LastMessage.Message.CreatedUtc.ToFriendlyDateTimeString(Model.Chapter.TimeZone)
                            </div>
                            @if (dto.LastMessage.Message.MemberId != dto.Conversation.MemberId)
                            {
                                <div>
                                    @dto.LastMessage.MemberFullName
                                </div>
                            }
                        </td>
                        <td>
                            @await Html.PartialAsync("Admin/_AdminLink", new AdminLinkViewModel
                            {
                                Route = OdkRoutes.GroupAdmin.Conversation(Model.Chapter, conversation.Id),
                                Text = "Reply"
                            })                            
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
else
{
    <p>No conversations</p>
}