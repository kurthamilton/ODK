@using ODK.Core.Utils
@using ODK.Services.Subscriptions.ViewModels
@using ODK.Web.Razor.Models.Payments
@model SiteSubscriptionsViewModel
@{    
    var (currency, currentMember, memberSubscription, subscriptions, paymentSettings) = 
        (Model.Currency, Model.CurrentMember, Model.CurrentMemberSubscription, Model.Subscriptions, Model.PaymentSettings);
}

@if (currency == null)
{
    var currencyOptions = Model.Currencies
        .Select(x => new SelectListItem { Value = x.Id.ToString(), Text = x.ToString() })
        .OrderBy(x => x.Text)
        .ToArray();

    <form action="/account/currency" method="post">
        @*@Html.AntiForgeryToken()*@
        <div class="form-group mb-3 required">
            @Html.Label("currencyId", "Choose currency", new { @class = "form-label" })
            @Html.DropDownList("currencyId", currencyOptions, "", new 
                { 
                    @class = "form-select", 
                    data_val = "true", 
                    data_val_required = "The Currency field is required" 
                })
            @Html.ValidationMessage("currencyId")
        </div>

        <button class="btn btn-primary">Update</button>
    </form>
    return;
}

<div data-odk-component="_SiteSubscriptionContent">
    <div class="form-group mb-3">
        <label class="form-label">Current subscription</label>
        <div class="form-control-plaintext">
            @(memberSubscription?.SiteSubscription.Name ?? "-")
        </div>
    </div>

    <div class="form-group mb-3">
        <label class="form-label">Next payment date</label>
        <div class="form-control-plaintext">
            @if (memberSubscription?.ExpiresUtc != null)
            {
                <span>
                    @memberSubscription.ExpiresUtc.Value.ToFriendlyDateString(null)
                </span>
            }
            else
            {
                <span>-</span>
            }
        </div>
    </div>

    @if (Model.CurrentMemberSubscription?.SiteSubscriptionPrice?.IsPaid != true)
    {
        <h3>Upgrade</h3>

        <div class="d-md-flex gap-3">
            @foreach (var subscriptionDto in subscriptions.OrderBy(x => x.Subscription.DisplayOrder))
            {
                var subscription = subscriptionDto.Subscription;
                var prices = subscriptionDto.Prices
                    .Where(x => x.IsPaid)
                    .OrderByDescending(x => x.Amount)
                    .ToArray();
                if (prices.Length == 0)
                {
                    continue;
                }

                <div class="mb-3 col">
                    @await Html.PartialAsync("Account/_SiteSubscriptionCard", subscriptionDto)
                </div>              
            }
        </div>
    }
</div>